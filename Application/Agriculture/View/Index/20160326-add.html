<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>农事信息关联</title>
    <link rel="stylesheet" href="__PUBLIC__/css/reset.css">
    <link rel="stylesheet" href="__PUBLIC__/css/common/common.css">
    <link rel="stylesheet" href="__PUBLIC__/css/common/table.css">
    <link rel="stylesheet" href="__PUBLIC__/css/agriculture/agriculture.css">
    <link rel="stylesheet" href="__PUBLIC__/css/agriculture/add.css">
    <link type="text/css" rel="stylesheet" href="__PUBLIC__/css/bootstrap-3.3.6.min.css" />
    <link type="text/css" rel="stylesheet" href="__PUBLIC__/css/jquery.bootgrid-1.3.1.min.css" />
    <script type="text/javascript" src="__PUBLIC__/js/jquery-2.1.4.min.js"></script>
    <script type="text/javascript" src="__PUBLIC__/js/bootstrap-3.3.6.min.js"></script>
    <script type="text/javascript" src="__PUBLIC__/js/jquery.bootgrid-1.3.1.js"></script>
    <script type="text/javascript" src="__PUBLIC__/js/common.js"></script>
</head>
<body>

<!--侧边栏-->
<include file="./Application/Common/Tpl/header.html" />
<include file="./Application/Common/Tpl/aside.html" />

<!--正文-->
<article class="fLeft">
    <section>
      <div class="w-content">
        <!-- 表单提交框架 -->
          <iframe name="sub" style="display:none;"></iframe>
          <!-- 表单 -->
          <form id="form" target="sub" method="POST" action="{:U('Agriculture/Createnew/addData')}?iframe_upload=submitCallback">
            <!-- 公司ID -->
            <input id="companyID" name="companyID" type="hidden" />
            <table class="w-table" border=1>
              <tr>
                <td>操作者头像：</td>
                <td>
                  <div class="w-operator">
                    <!-- 操作者头像 -->
                    <img src="" title="头像" alt="头像" />
                    <br />
                    <input id="head" type="file" accept="image/jpeg" />
                    <input id="operator" name="operator" type="hidden" />
                    <div id="operatorProgress" class="jlm_progress"></div>
                  </div>
                </td>
              </tr>
              <tr>
                <td>操作图片：</td>
                <td>
                  <div id="images">
                    <!-- 操作图片 -->
                    <div class="w-images">
                      <img src="" title="操作" alt="操作" /><input type="file" accept="image/jpeg" />
                      <input name="images[][imagePath]" type="hidden" />
                      <div class="jlm_progress"></div>
                    </div>
                  </div>
                </td>
              </tr>
              <tr>
                <td>选择产品：</td>
                <td>
                  <div class="w-products">
                    <!-- 产品 -->
                    <select id="products">
                      <option value="-1">正在加载产品列表……</option>
                    </select>
                  </div>
                </td>
              </tr>
              <tr>
                <td>选择操作：</td>
                <td>
                  <div class="w-operators">
                  <!-- 操作 -->
                    <select id="operators" name="operatorID">
                      <option class="jlm_choose" value="-1">==请先选择产品==</option>
                    </select>
                    <input id="dataName" name="dataName" type="hidden" />
                  </div>
                </td>
              </tr>
              <tr>
                <td>事件发生时间：</td>
                <td>
                   <div class="w-time">
                    <!-- 事件发生时间 -->
                    <input type="text" disabled="disabled" />
                    <!-- @徐鸿飞：注意啊！！！！把上面这个编辑框选择的时间转换成13位的时间戳，放到下面的这个编辑框中啊！！！记得啊！！！！！
                    @徐鸿飞：我路过，就看了看！-->
                    <input id="eventTime" name="eventTime" type="hidden" />
                  </div>
                </td>
              </tr>
              <tr>
                <td>事件详情：</td>
                <td>
                  <div class="w-dataDetails">
                    <!-- 事件详情 -->
                    <textarea name="dataDetails" placeholder="填写事件详情"></textarea>
                  </div>
                </td>
              </tr>
              <tr>
                <td>经纬度：</td>
                <td>
                  <div class="w-longitude_latitude">
                    <!-- 经纬度 -->
                    <input name="longitude" type="number" title="经度" placeholder="经度" />
                    <input name="latitude" type="number" title="纬度" placeholder="纬度" />
                  </div>
                </td>
              </tr>
              <tr>
                <td>位置：</td>
                <td>
                   <div class="w-userlocation">
                    <!-- 位置 -->
                    <input name="userlocation" type="text" placeholder="位置" />
                  </div>
                </td>
              </tr>
            </table>
            <div class="w-button">
              <button type="submit" onclick="submitForm();return false;">提交</button>
            </div>
          </form>
      </div>
    </section>
</article>
<include file="./Application/Common/Tpl/footer.html" />
</body>

<script>
//jQuery 元素拾取
var companyID = $("#companyID"), products = $("#products"), operators = $("#operators"),
  head = $("#head"), images = $("#images"), operatorProgress = $("#operatorProgress"),
  operator = $("#operator"), dataName = $("#dataName"), eventTime = $("#eventTime");
(function() {
var datee = new Date();
eventTime.prev("input").val(datee.getFullYear() + "-" + (datee.getMonth() + 1) + "-" + datee.getDate() + " " + datee.getHours() + ":" + datee.getMinutes() + ":" + datee.getSeconds());
eventTime.val(datee.getTime());
  //获取公司ID信息
  $.ajax({
    url: "/API/Public/validation",
    method: "get",
    dataType: "json",
    success: function(data) {
      typeof data == "string" && (data = eval("(" + data + ")"));
      if(data.code === "001" && data.result.companyid && data.result.companyid-0 != 0) {
        companyID.val(data.result.companyid); //公司ID
      } else {
        window.history.back();
      }
    },
    error: function(err) {
      console.error(err);
      alert("加载失败！");
      window.history.back();
    }
  });
  //获取产品列表
  $.ajax({
    url: "/Company/Lot/products",
    method: "get",
    dataType: "json",
    success: function(data) {
      typeof data == "string" && (data = eval("(" + data + ")"));
      products.children().remove();
      if(data.code === "001") {
        products.append(
          $('<option></option>').addClass("jlm_choose").attr("value", "-1").text("== 请选择产品 ==")
        );
        for(var i = 0; i < data.result.length; i++) {
          products.append(
            $('<option></option>').attr("value", data.result[i].id).text(data.result[i].name + " - " + data.result[i].spec)
          );
        }
      } else {
        window.history.back();
      }
    },
    error: function(err) {
      console.error(err);
      alert("加载失败！");
      window.history.back();
    }
  });
  //获取操作列表
  products.change(function() {
    if(products.val() != -1) {
      $.ajax({
        url: "/API/company/fetchoperation",
        method: "post",
        dataType: "json",
        data: {
          productId: products.val()
        },
        success: function(data) {
          typeof data == "string" && (data = eval("(" + data + ")"));
          operators.children().remove();
          if(data.code === "001") {
            operators.append(
              $('<option></option>').addClass("jlm_choose").attr("value", "-1").text("== 请选择操作 ==")
            );
            for(var i = 0; i < data.result.length; i++) {
              operators.append(
                $('<option></option>').attr("value", data.result[i].id).text(data.result[i].name)
              );
            }
          } else {
            window.history.back();
          }
        },
        error: function(err) {
          console.error(err);
          alert("加载失败！");
          window.history.back();
        }
      });
    } else {
      operators.children().remove().append(
        $('<option></option>').addClass("jlm_choose").attr("value", "-1").text("请先选择产品")
      );
    }
    operators.val(-1);
  });
  operators.change(function() {
    dataName.val(operators[0].options[operators[0].selectedIndex].text);
  });
  //选择头像
  head.change(function() {
    if(head.val() == "") {
      head.prev("img")[0].src = "";
    } else {
      setImagePreview(head[0], head.prev("img")[0])
    }
  });
  //选择图片
  images.delegate("input", "change", function(e) {
    //预览选择
    if(e.target.value != "") {
      setImagePreview(e.target, $(e.target).prev("img")[0]);
    } else {
      $(e.target).prev("img")[0].src = "";
    }
    //删除空编辑框和重复文件
    var children = images.children("div");
    for(var i = 0; i < children.length; i++) {
      if($(children[i]).children("input")[0].value == "") {
        $(children[i]).remove();
      } else {
        var files = images.children("div");
        for(var f = 0; f < files.length; f++) {
          if(children[i] != files[f] && $(children[i]).children("input")[0].value == $(files[f]).children("input")[0].value) {
            $(children[i]).remove();
            layer.msg("选择了文件名相同的文件", {icon: 0, timeout: 3000});
          }
        }
      }
    }
    //新增文件选择框
    images.append(
      $('<div></div>').addClass("w-images").append(
        $('<img />').attr("src", "").attr("alt", "操作").attr("title", "操作")
      ).append(
        $('<input />').attr("type", "file").attr("accept", "image/jpeg")
      ).append(
        $('<input />').attr("name", "images[][imagePath]").attr("type", "hidden")
      ).append(
        $('<div></div>').addClass("jlm_progress")
      )
    );
  });
})();
//图片上传前预览
function setImagePreview(docObj, imgObjPreview) {
  //imgObjPreview.style.display = 'block';
  //imgObjPreview.style.width = '160px';
  //imgObjPreview.style.height = '120px';
  if(docObj.files && docObj.files[0]) {
    try {
      imgObjPreview.src = docObj.files[0].getAsDataURL();
    } catch(e) {
      //火狐7以上版本不能用上面的getAsDataURL()方式获取，需要一下方式
      imgObjPreview.src = window.URL.createObjectURL(docObj.files[0]);
    }
  } else {
    //IE下，使用滤镜
    docObj.select();
    var imgSrc = document.selection.createRange().text;
    //图片异常的捕捉，防止用户修改后缀来伪造图片
    try {
      imgObjPreview.style.filter="progid:DXImageTransform.Microsoft.AlphaImageLoader(sizingMethod=scale)";
      imgObjPreview.filters.item("DXImageTransform.Microsoft.AlphaImageLoader").src = imgSrc;
    } catch(e) {
      layer.msg("您上传的图片格式不正确，请重新选择!", {icon: 2, timeout: 3000});
      docObj.value = "";
      return false;
    }
    imgObjPreview.style.display = 'none';
    document.selection.empty();
  }
  return true;
}
/** 上传文件类
 *
 * @param Object option 参数{url:"上传地址", field:"上传字段", callback:"回调函数", progress:"进度回调函数"}
 */
var UploadFile = function(option) {
  var fd = new FormData(), xhr = new XMLHttpRequest();
  return {
    upload: function(files) {
      if(files instanceof Array && files.length > 0) {
        for(var i = 0; i < files.length; i++) {
          fd.append(option.field, files[i]);
        }
        xhr.onreadystatechange = function() {
          if(xhr.readyState == 4 && xhr.status == 200) {
            if(option.callback instanceof Function) {
              option.callback(xhr.responseText);
            }
          }
        }
        if(option.progress instanceof Function) {
          xhr.upload.onprogress = function(e) {
            option.progress(Math.floor(100 * e.loaded / e.total));
          }
        }
        xhr.open("POST", option.url);
        xhr.send(fd);
      }
    }
  };
};
//验证表单
function validationForm() {
  var er = true;
  if(companyID.val() == "") {
    alert("加载失败！");
    window.history.back();
    return false;
  } if(head.val() == "") {
    head.parent("div").addClass("jlm_error");
    er = false;
  } if(images.children("div").length < 1) {
    alert("加载失败！");
    window.history.back();
    return false;
  } if(images.children("div").length == 1 && $(images.children("div")[0]).children("input[type='file']").val() == "") {
    images.addClass("jlm_error");
    er = false;
  } if(products.val() == "-1") {
    products.addClass("jlm_error");
    er = false;
  } if(operators.val() == "-1") {
    operators.addClass("jlm_error");
    er = false;
  } if(eventTime.val() == "") {
    eventTime.parent("div").addClass("jlm_error");
    er = false;
  }
  return er;
}
//提交表单
function submitForm() {
  $("input,textarea,select,button").prop("disabled", true);
  $(".jlm_error").removeClass("jlm_error");
  layer.msg("正在提交，请稍后！", {icon: 1, timeout: 3000});
  if(validationForm()) {
    //上传图片
    var img = images.children("div");
    var index = 0;
    ufi = new UploadFile({
      url: "{:U('Agriculture/Createnew/uploadTemp')}?type=event",
      field: "fileInfo",
      callback: function(data) {
        typeof data == "string" && (data = eval("(" + data + ")"));
        if(data.code == "001" && data.result.code == 0) {
          $(img[index]).children("input[type='hidden']").val(data.result.message);
          index++;
          up();
        } else {
          layer.msg("操作图片提交失败！<br />" + data.result.message, {icon: 5, timeout: 5000});
          $("input,textarea,select,button").prop("disabled", false);
        }
      },
      progress: function(p) {
        $(img[index]).children("div").css("width", p + "%");
      }
    });
    var up = function() {
      if(index >= img.length) {
        $("input,textarea,select,button").prop("disabled", false);
        $("#form").submit();
        return;
      }
      if($(img[index]).children("input[type='file']").val() == "") {
        index++;
        up();
        return;
      }
      ufi.upload([$(img[index]).children("input[type='file']")[0].files[0]]);
    };
    //上传头像
    var ufh = new UploadFile({
      url: "{:U('Agriculture/Createnew/uploadTemp')}?type=head",
      field: "fileInfo",
      callback: function(data) {
        typeof data == "string" && (data = eval("(" + data + ")"));
        if(data.code == "001" && data.result.code == 0) {
          operator.val(data.result.message);
          up();
        } else {
          layer.msg("头像提交失败！<br />" + data.result.message, {icon: 5, timeout: 5000});
          $("input,textarea,select,button").prop("disabled", false);
        }
      },
      progress: function(p) {
        operatorProgress.css("width", p + "%");
      }
    });
    ufh.upload([head[0].files[0]]);
  } else {
    $("input,textarea,select,button").prop("disabled", false);
    layer.msg("表单填写有误，请检查！", {icon: 5, timeout: 3000});
  }
}
//提交表单回调函数
function submitCallback(data) {
  if(data.code == "001" && data.result.code == 0) {
    window.location.replace("{:U('Agriculture/Index/agriculture')}");
  } else {
    layer.msg(data.result.message, {icon: 5, timeout: 5000});
  }
}
</script>
<script src="__PUBLIC__/js/jquery-2.1.4.min.js"></script>
<script src="__PUBLIC__/js/layer-2.1.min.js"></script>
</html>