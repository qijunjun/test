/*
	Revision 00115 - 2016/06/10
	By James "Carbon" leon Neo
*/
$(document).ready(function(){function e(e){var t,n,a,d,r;t=e.id,n=e.title,a=e.description,d=e.status,r=e.rules,this.id=function(){return t},this.title=function(){return n},this.description=function(){return a},this.status=function(){return d},this.rules=function(){return r}}function t(){var t,n;t=[],n={},this.add=this.update=function(a){a instanceof e&&(void 0==n[a.id()]?(t.push(a),n[a.id()]=t.length-1):t[n[a.id()]]=a)},this.get=function(e){return t[n[e]]}}function n(e){var t;t=e.id,this.id=function(){return t}}function a(e,t){var n,a;n=e,a=t,this.nodes=function(){return n},this.menu=function(e){return a.rule[e]},this.rule=function(e){return a.menu[e]}}function d(t){function n(){var e,t,n,a,d,r,i,o,s;if(e=$("#tab_headers span.tab_header"),t=$("#tabs div.tab"),e.length==t.length){for(n=window.event||arguments[0],a=n.target||n.srcElement,i=e.length,s=0;i>s;s++)d=e[s],d==a?($(d).addClass("tab_header_selected"),o=s):$(d).removeClass("tab_header_selected");for(i=t.length,s=0;i>s;s++)r=t[s],s==o?$(r).removeClass("tab_hide"):$(r).addClass("tab_hide")}}var a,d,l,l,u,p,h,m;c||(a=!isNaN(t),d=a?575:550,l=(a?"编辑":"添加")+"权限组",layer.open({area:["640px",d+"px"],title:l,btn:["确定","取消"],success:function(e){var d,f,b,g,v,C,y,E,N,_,k,w,j,x,T,H;c=!0,f=e.children(".layui-layer-content")[0],f.style.paddingBottom="0px",b=document.createElement("div"),b.className="item",g=document.createElement("span"),g.innerHTML="名称",b.appendChild(g),l=document.createElement("input"),l.id="title",l.type="text",b.appendChild(l),f.appendChild(b),b=document.createElement("div"),b.className="item",g=document.createElement("span"),g.innerHTML="说明",u=document.createElement("textarea"),u.id="description",b.appendChild(g),b.appendChild(u),f.appendChild(b),a&&(b=document.createElement("div"),b.className="item",g=document.createElement("span"),g.innerHTML="启用",p=document.createElement("input"),p.id="status",p.type="checkbox",b.appendChild(g),b.appendChild(p),f.appendChild(b)),v=document.createElement("div"),v.id="tab_headers",f.appendChild(v),g=document.createElement("span"),g.innerHTML="选择菜单",g.className="tab_header tab_header_selected",$(g).click(n),v.appendChild(g),g=document.createElement("span"),g.innerHTML="选择规则",g.className="tab_header",$(g).click(n),v.appendChild(g),C=document.createElement("div"),C.id="tabs",f.appendChild(C),b=document.createElement("div"),b.className="tab",C.appendChild(b),y=document.createElement("div"),y.className="ztree",y.id="menus",b.appendChild(y),b=document.createElement("div"),b.className="tab tab_hide",C.appendChild(b),E=document.createElement("table"),E.className="table table-condensed table-hover table-striped",E.id="rules",header=document.createElement("thead"),E.appendChild(header),N=document.createElement("tr"),header.appendChild(N),_=document.createElement("th"),_.innerHTML="规则",$(_).data("columnId","title"),N.appendChild(_),b.appendChild(E),h=$.fn.zTree.init($(y),r,o.nodes()),h.checkNode(h.getNodeByParam("id",1),!0),m=$(E).bootgrid({identifier:"id",data:i,rowCount:5,navigation:2,selection:!0,multiSelect:!0,keepSelection:!0}).on("loaded.rs.jquery.bootgrid",function(){if(a)for(d=s.get(t),l.value=d.title(),u.value=d.description(),p.checked=d.status(),k=d.rules().replace("|",",").split(","),w=k.length,H=0;w>H;H++)j=k[H],x=o.menu(j),x?(T=h.getNodeByParam("id",x),h.checkNode(T,!0,!0)):m.bootgrid("select",[j])})},yes:function(n){var d,r,i,f,b,g,v,C,y,E,N;if(l&&u||window.location.reload(),!l.value)return void alert();for(d=h.getCheckedNodes(),r=m.bootgrid("getSelectedRows"),i=[],f=d.length,N=0;f>N;N++)b=d[N],b.getParentNode()&&i.push(o.rule(b.data.id()));g="/admin/group/"+(a?"edit":"add"),v={title:l.value,description:u.value,rules:i.join(",")+"|"+r.join(",")},a&&(v.id=t,v.status=p.checked?1:0),$.ajax({url:g,method:"post",dataType:"json",async:!1,data:v,success:function(n){E="001"===n.code,E?(y=n.result,a?(y.id=t,C=new e(y),s.update(C),$("#groups").bootgrid("update",[t],[y]),alert("编辑成功！")):(C=new e(y),s.add(C),$("#groups").bootgrid("append",[y]),alert("添加成功！"))):console.error(n)},error:function(e){E=!1,console.error(e)}}),E&&(c=!1,h.destroy(),m.bootgrid("destroy"),layer.close(n))},cancel:function(e){c=!1,h.destroy(),m.bootgrid("destroy")}}))}var r,i,o,s,c;r={callback:{beforeCheck:function(e,t){return t.isParent&&!t.children?!1:void 0}},check:{enable:!0},data:{key:{name:"title"},simpleData:{enable:!0,pIdKey:"parent_id"}}},s=new t,c=!1,$.ajax({url:"/admin/group/rules",method:"get",dataType:"json",success:function(e){var t,d,r,s,c;if("001"===e.code){t=e.result,i=[];for(r in t.rules)s=t.rules[r],1==s.type&&(s.id=r,i.push(s));d=[];for(r in t.menus)s=t.menus[r],s.id=r,s.parent_id||(s.parent_id=0,s.isParent=!0),s.chkDisabled=!s.status,delete s.status,s.data=new n(s),d.push(s);c=t.map,o=new a(d,c)}else console.error(e)},error:function(e){console.error(e)}}),$("#groups").bootgrid({ajax:!0,ajaxSettings:{dataType:"json"},url:"/admin/group/fetch",responseHandler:function(t){var n,a,d,r,i;if(n=[],a=t.result.rows,!(a instanceof Array)){for(i in a)d=a[i],d.id=i,r=new e(d),s.add(r),n.push(d);t.result.rows=n}return t},withSearchField:!1,identifier:"id",converters:{description:{to:function(e){return e}},status:{to:function(e){return e?"启用":"禁用"}}},formatters:{commands:function(e,t){return'<input type="button" value="编辑" />'}}}).on("loaded.rs.jquery.bootgrid",function(){var e;e=$(this).bootgrid("getCurrentIdentifiers"),$(this).find("input").click(function(){var t;t=e[this.parentNode.parentNode.rowIndex-1],d(t)})}),$("#add").click(d)});
