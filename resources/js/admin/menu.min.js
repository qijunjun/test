/*
	Revision 00146 - 2016/04/24
	By James "Carbon" leon Neo
*/
$(document).ready(function(){function e(e){var n,t;n=e.name,t=e.path,this.name=function(){return n},this.path=function(){return t}}function n(e){var n,t,a,d;n=e.id,t=e.status,a=e.path,d=e.icon,this.id=function(){return n},this.status=function(){return t},this.path=function(){return a},this.node=function(){return a?g[a]:null},a||(this.icon=function(){return d})}function t(e,n){var t,i,o,r,c,l;w||(w=!0,n?t=e:(t=e.data?v.addNodes(e,{name:""})[0]:e,v.editName(t)),i=$("#"+t.tId+"_span"),o="<span class='button okay' id='okayBtn_"+t.tId+"' title='确认操作'></span>",r="<span class='button cancel' id='cancelBtn_"+t.tId+"' title='取消操作'></span>",i=$("#"+t.tId+"_span"),i.after(r).after(o),c=$("#okayBtn_"+t.tId),c.click(function(){a(t)}),l=$("#cancelBtn_"+t.tId),l.click(d),t.getParentNode()||(s.removeClass("hide"),$(u).removeClass("hide"),t.data?preview.innerHTML=t.data.icon():preview.innerHTML="请上传菜单项图片"))}function a(e){var t,a,i,o,r,c,l,s,u;if(t=e.data?!0:!1,a=$("#"+e.tId+"_input"),!a.val())return void alert("请输入菜单项标题！");if(i=e.getParentNode()){if(o=m.getSelectedNodes(),o.length>0?(r=o[0],t?r!=e.data.node()&&r.nocheck&&(r=null,alert("在左侧的节点列表中请维持原节点或选择另一个尚未选择过的功能节点！")):r.nocheck&&(r=null,alert("在左侧的节点列表中请选择一个尚未选择过的功能节点！"))):(r=null,alert("请在保存前先从左侧的节点列表中选择一个对应的功能节点！")),!r)return}else r=null;u=e,c="/admin/menu/"+(t?"edit":"add"),l={path:r?r.data.path():"",title:a.val()},t?(l.id=u.data.id(),1==u.data.id()&&(l.title="首页")):l.parentId=i?i.data.id():0,i||(l.icon=preview.innerHTML),$.ajax({url:c,method:"post",dataType:"json",data:l,success:function(a){var o;"001"===a.code?(t?(r&&r!=u.data.node()&&(r.nocheck=!0,m.updateNode(r,!1),r=u.data.node(),r.nocheck=!1,m.updateNode(r,!1)),u.name=a.result.title,u.data=null,u.data=new n(a.result),v.updateNode(u,!1),alert("编辑成功！")):(u.id=a.result.id,u.name=a.result.title,u.pId=a.result.parent_id,u.data=null,u.data=new n(a.result),i?(r.nocheck=!0,m.updateNode(r,!1)):(u.isParent=!0,s=v.addNodes(null,b)[0]),o=$("#"+e.tId+"_ico"),o.css("width",""),o.css("height",""),v.updateNode(u,!1),s&&v.setting.view.addHoverDom("menus",s),s=null,alert("添加成功！")),d()):console.error(a)},error:function(e){console.error(e)}})}function d(){var e;e=v.getSelectedNodes()[0],w=!1,v.cancelEditName(),!e.data&&e.getParentNode()&&v.removeNode(e),$(u).addClass("hide")}function i(){m=$.fn.zTree.init($("#nodes"),h,[]),v=$.fn.zTree.init($("#menus"),h,[]),m.setting.check={chkStyle:"radio",enable:!0,radioType:"all"},m.setting.callback={beforeCheck:function(e,n){return n.checked?!1:void 0},onCheck:function(e,n,t){m.selectNode(t,!1)},beforeClick:function(e,n,t){return n.nocheck&&n!=N?!1:void 0},onClick:function(e,n,t,a){m.checkNode(t,!0)}},v.setting.callback.onClick=function(e,n,t,a){var d,i,o,r;if(m.cancelSelectedNode(),N=null,t.data)if(d=t.data.node()){for(s.addClass("hide"),i=d.getPath(),o=i.length,r=o-2;r>=0;r--)d=i[r],m.expandNode(d,!0);N=i[o-1],m.selectNode(N)}else s.removeClass("hide"),preview.innerHTML=t.data.icon();else s.removeClass("hide"),preview.innerHTML="无"},v.setting.edit={drag:{isCopy:!1,isMove:!1},enable:!0,removeTitle:"删除菜单",renameTitle:"编辑菜单",showRemoveBtn:function(e,n){return n.id>1},showRenameBtn:function(e,n){var t,a;return t=v.getSelectedNodes(),a=t.length?t[0]:k,n.id>0&&!a.editNameFlag}},v.setting.view={removeHoverDom:function(e,n){n.id<0&&!n.editNameFlag||$("#addBtn_"+n.tId).unbind().remove()},showIcon:function(e,n){return n.id>0}},v.setting.view.addHoverDom=function(e,n){var a,d,i,o,r,c;1!=n.id&&(a=n.getParentNode(),d=v.getSelectedNodes(),i=d.length>0?d[0]:k,null!=a||i.editNameFlag||n.editNameFlag||$("#addBtn_"+n.tId).length>0||(o=$("#"+n.tId+"_span"),r="<span class='button add' id='addBtn_"+n.tId+"' title='添加菜单'></span>",o.after(r),c=$("#addBtn_"+n.tId),c.click(function(){t(n,!1)})))},v.setting.callback.beforeEditName=function(e,n){t(n,!0)},v.setting.callback.beforeRemove=function(e,n){var t;return $.ajax({url:"/admin/menu/remove",method:"post",dataType:"json",data:{id:n.data.id()},success:function(e){if("001"===e.code){if(n.getParentNode())t=n.data.node(),t.nocheck=!1,m.updateNode(t,!1);else if(n.children)for(index in n.children)t=n.children[index].data.node(),t.nocheck=!1,m.updateNode(t,!1);v.removeNode(n),alert("删除成功！")}else console.error(e)},error:function(e){console.error(e)}}),!1},v.setting.callback.beforeRename=function(e,n,t,a){return a?($("#okayBtn_"+n.tId).unbind().remove(),$("#cancelBtn_"+n.tId).unbind().remove(),!0):!1}}function o(n){var t,a,d,i;g=[];for(index in n)t=n[index],d=t.path.indexOf("/")>=0?t.path.match(/\//g).length:0,d?(i=t.path.lastIndexOf("/"),a=g[t.path.substr(0,i)],a=m.addNodes(a,{name:t.name},!0)[0]):a=m.addNodes(null,{name:t.name,isParent:!0})[0],a.data=new e(t),g[t.path]=a}function r(e,t){var a,d,i,o,r;a=[];for(index in e)d=e[index],index<=0||d.parent_id<0||(d.id=index,d.parent_id||(d.parent_id=0,d.icon=t[index]),i={id:index,pId:d.parent_id,name:d.title,data:new n(d),isParent:0==d.parent_id},a.push(i),o=i.data.node(),o&&(o.nocheck=!0,m.updateNode(o,!1)));a.push(b),v.addNodes(null,a),r=v.getNodeByParam("id",-1),v.setting.view.addHoverDom("menus",r)}function c(){var e;e=f.result,p.test(e)?(e=e.replace(/^(\b|\s)*/,""),e=e.replace(/(\b|\s)*$/,""),preview.innerHTML=e,console.log(e)):(preview.innerHTML="",u.value="")}function l(){u.files.length&&f.readAsText(u.files[0])}var s,u,f,p,h,m,v,g,N,k,b,w;s=$("#icon"),u=document.getElementById("file"),preview=document.getElementById("preview"),f=new FileReader,p=/^(\b|\s)*<svg(\b|\s|.)*>(\b|\s|.)*<\/svg>(\b|\s)*$/i,$(u).on("change",l),$(f).load(c),h={view:{autoCancelSelected:!1,selectedMulti:!1,showLine:!1},data:{keep:{parent:!0},simpleData:{enable:!0}},callback:{beforeExpand:function(e,n){var t,a,d;for(t=$.fn.zTree.getZTreeObj(e),a=n.getPreNode();null!=a;)t.expandNode(a,!1),a=a.getPreNode();for(d=n.getNextNode();null!=d;)t.expandNode(d,!1),d=d.getNextNode();t=null}}},k={editNameFlag:!1},b={id:-1,pId:0,name:"",isParent:!1},w=!1,$.ajax({url:"/admin/menu/fetch",method:"get",dataType:"json",success:function(e){var n;"001"===e.code?(n=e.result,i(),o(n.nodes),r(n.menus,n.icons)):console.error(e)},error:function(e){console.error(e)}})});
